<!documenttype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/aheader.css" />
		<link rel="stylesheet" type="text/css" href="css/chat.css" />
				<style>
					html,
					body {
						height: 100%;
						margin: 0px;
						padding: 0px;
						overflow: hidden;
						-webkit-touch-callout: none;
						-webkit-user-select: none;
					}
				</style>
	</head>

	<body>
		
		<header class="mui-bar mui-bar-nav title" style="position: fixed;">
					<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left title-color"></a>
					<h1 class="mui-title title-color"><b id="chatting-nickname">Chat</b></h1>
		</header>
		
				<div id="msg-outter" class="mui-content">
					<div id='msg'>
						
						<!-- <div class="friend_lists">
							<div class="header_img">
								<img src="image/view.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper right">
								<p class="msg-left-white">晚上过来吃饭？</p>
							</div>
						</div>
						<div class="me_lists">
							<div class="header_img">
								<img src="plugin/cropper/images/picture.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper left">
								<p class="msg-right-green">好的，没问题！时间地点？</p>
							</div>
						</div>
						<div class="friend_lists">
							<div class="header_img">
								<img src="image/view.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper right">
								<p class="msg-left-white">晚上过来吃饭？</p>
							</div>
						</div>
						<div class="me_lists">
							<div class="header_img">
								<img src="plugin/cropper/images/picture.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper left">
								<p class="msg-right-green">好的，没问题！时间地点？</p>
							</div>
						</div>
						<div class="friend_lists">
							<div class="header_img">
								<img src="image/view.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper right">
								<p class="msg-left-white">晚上过来吃饭？</p>
							</div>
						</div>
						<div class="me_lists">
							<div class="header_img">
								<img src="plugin/cropper/images/picture.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper left">
								<p class="msg-right-green">好的，没问题！时间地点？</p>
							</div>
						</div>
						<div class="friend_lists">
							<div class="header_img">
								<img src="image/view.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper right">
								<p class="msg-left-white">晚上过来吃饭？</p>
							</div>
						</div>
						<div class="me_lists">
							<div class="header_img">
								<img src="plugin/cropper/images/picture.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper left">
								<p class="msg-right-green">好的，没问题！时间地点？</p>
							</div>
						</div>
						<div class="friend_lists">
							<div class="header_img">
								<img src="image/view.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper right">
								<p class="msg-left-white">晚上过来吃饭？</p>
							</div>
						</div>
						<div class="me_lists">
							<div class="header_img">
								<img src="plugin/cropper/images/picture.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper left">
								<p class="msg-right-green">好的，没问题！时间地点？</p>
							</div>
						</div>
						<div class="friend_lists">
							<div class="header_img">
								<img src="image/view.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper right">
								<p class="msg-left-white">晚上过来吃饭？</p>
							</div>
						</div>
						<div class="me_lists">
							<div class="header_img">
								<img src="plugin/cropper/images/picture.jpg" width="40px" height="40px" />
							</div>
							<div class="msg-wrapper left">
								<p class="msg-right-green">好的，没问题！时间地点？</p>
							</div>
						</div> -->
		
					</div>
				</div>
				
				<footer>
					<div class="footer-center">
						<textarea id='msg-text' type="text" class='input-text'></textarea>
					</div>
					<label for="" class="footer-right">
						<button type="button" class="mui-btn mui-btn-gray" id="send">发送</button>
					</label>
				</footer>
		
		
		
		<script src="js/mui.js"></script>
		<script type="application/javascript" src="js/app.js"></script>
		<script type="text/javascript">
               //创建命名空间，只需要把自己的代码，写进入，那么外部就无法访问
//				(function($,document){
					
					//获取上一个页面传来的数据
					var friendsUserId;
					var friendsNickname;
					var friendsFaceImage;
					
					mui.plusReady(function () {
					    
						//获取我自己用户的信息
						var me = app.getUserGlobalInfo();
						
						//获取聊天页面的webview
						var chattingWebview = plus.webview.currentWebview();
						// 设置聊天页面的软键盘样式
						chattingWebview.setStyle({
							softinputMode: 'adjustResize'
						});
						
						//获取上一个页面传来的数据
						 friendsUserId = chattingWebview.friendsUserId;
						 friendsNickname = chattingWebview.friendsNickname;
						 friendsFaceImage = chattingWebview.friendsFaceImage;
						 
						//标题改为朋友的名称
						document.getElementById('chatting-nickname').innerHTML = friendsNickname;
						
						//初始化聊天记录
						initChatHistory();
						
						var areaMsg = document.getElementById('msg');
						//设置聊天页面自动滚动到最后一条
						areaMsg.scrollTop = areaMsg.scrollHeight + areaMsg.offsetHeight;
						
						
						//设置输入信息后发送按钮的变化
						var msg_text = document.getElementById('msg-text');
						var send = document.getElementById('send');
						msg_text.addEventListener('input',function(){
							var msg_text_val = msg_text.value;
							if(msg_text_val.length > 0){
								send.setAttribute('class','mui-btn-green');
							}else{
								send.setAttribute('class','mui-btn-grey');
							}
						});
						
						//对当前窗口监听resize事件
						window.addEventListener('resize',function(){
							resizeScreen();
							document.getElementById('msg-outter').style.paddingBottom = '50px';
						});
						
						//发送消息按钮事件绑定
						send.addEventListener('tap',function(){
							
							//发送之前判断网络的状态
							var connectionStatus = plus.networkinfo.getCurrentType();
							
							if(connectionStatus == 0 || connectionStatus == 1){
								app.showToast('请打开网络连接...','error');
								return;
							}
							
							//获取消息内容，如果内容长度为0 return
							var msg_text_val = msg_text.value;
							
							if(msg_text_val.length === 0){
								return;
							};
							
							Msgsend(app.imgServerUrl + me.image,msg_text_val);
							msg_text.value = "";
							send.setAttribute('class','mui-btn-grey');
							
							//构建ChatCon
							console.log(friendsUserId);
							var chatCon = new app.ChanCon(me.id,friendsUserId,msg_text_val,null);
							//构建DataContent
							console.log(app.CHAT);
							var dataContent = new app.DataContent(app.CHAT,chatCon,null);
							
							//调用websocket 发送消息到netty后端
							var wsWebview = plus.webview.getWebviewById('chatlist.html');
							//通过对应的webview调用它的函数
							wsWebview.evalJS("CHAT.chat('" + JSON.stringify(dataContent) + "')");
							
							//保存用户历史聊天记录到本地缓存
							app.saveUserChatHistory(me.id,friendsUserId,msg_text_val,1);
							//保存用户快照信息记录到本地缓存
							app.saveUserChatSnapshoot(me.id,friendsUserId,msg_text_val,true);
							
							//MsgReceive('模拟接受消息..........·');
						});
						
					});
					
					
					//发送信息铃声
					function playsendMsgSound(){
						var audioPlayr = plus.audio.createPlayer('/mp3/send.mp3');
					    audioPlayr.play();
					}
					
					//接受信息铃声
					function playreceiveMsgSound(){
						var audioPlayr = plus.audio.createPlayer('/mp3/send.mp3');
					    audioPlayr.play();
					}
					
					
					//接受消息
					function MsgReceive(Msg){
						
						var MsgHtml = '<div class="friend_lists">'+
											'<div class="header_img">'+
												'<img src="'+app.imgServerUrl+friendsFaceImage+'" width="40px" height="40px" />'+
											'</div>'+
											'<div class="msg-wrapper right">'+
												'<p class="msg-left-white">'+Msg+'</p>'+
											'</div>'+
										'</div>';
						var msg_list = document.getElementById('msg');
						msg_list.insertAdjacentHTML('beforeend',MsgHtml);
						playsendMsgSound();
					};
					
					//发送消息功能
					function Msgsend(FaceImage,Msg){
						
						var MsgHtml = '<div class="me_lists">'+
											'<div class="header_img">'+
												'<img src="'+FaceImage+'" width="40px" height="40px" />'+
											'</div>'+
											'<div class="msg-wrapper left">'+
												'<p class="msg-right-green">'+Msg+'</p>'+
											'</div>'+
										'</div>';
									var msg_list = document.getElementById('msg');
									msg_list.insertAdjacentHTML('beforeend',MsgHtml);
									playsendMsgSound();
					};
					
					
					//设置点开文本框后 页面上拉  重新调整窗口
					function resizeScreen(){
						var areaMsg = document.getElementById('msg');
						//设置聊天页面自动滚动到最后一条
						areaMsg.scrollTop = areaMsg.scrollHeight + areaMsg.offsetHeight;
						
					};
					
					
					//初始化用户聊天记录
				    function initChatHistory(){
						
						var msg_list = document.getElementById('msg');
						
						var me =app.getUserGlobalInfo();
						var myId =me.id;
						var myFaceImage = me.faceImage;
						
						var chatHistoryList = app.getUserChatHistory(myId,friendsUserId);
						var userChatHistory = "";
						
						for(var i = 0; i < chatHistoryList.length; i++){
							var singleMsg = chatHistoryList[i];
							
							if(singleMsg.flag == 2){
								userChatHistory += '<div class="friend_lists">'+
													'<div class="header_img">'+
														'<img src="'+app.imgServerUrl+friendsFaceImage+'" width="40px" height="40px" />'+
													'</div>'+
													'<div class="msg-wrapper right">'+
														'<p class="msg-left-white">'+singleMsg.msg+'</p>'+
													'</div>'+
												'</div>';
								
							}else{
								
								userChatHistory += '<div class="me_lists">'+
													'<div class="header_img">'+
														'<img src="'+app.imgServerUrl+ myFaceImage +'" width="40px" height="40px" />'+
													'</div>'+
													'<div class="msg-wrapper left">'+
														'<p class="msg-right-green">'+singleMsg.msg+'</p>'+
													'</div>'+
												'</div>';
							}
						}
						
						msg_list.innerHTML += userChatHistory;
					}
					
					
//				}(mui,documentument));
			
		</script>
	</body>

</html>
